---
title: "Make Payment"
description: "Simple flask application that is responsible for handling payments"
lead: "Chall 1"
draft: false
images: []
menu:
  docs:
    parent: "Injection"
toc: true
authors: Vaibhav Rajput
---

{{< tabs tabTotal="2">}}
{{% tab tabName="Challenge" %}}

- We urgently need a microservice that can handle payments. So our new intern created one using flask and werkzeug but it seems that our new intern made a mistake. We require your excellent skills to figure out the issue.

makePayment.py
````python {linenos=true,anchorlinenos=true}
from flask import Flask, request
import hashlib
import sqlite3

app = Flask(__name__)


@app.route("/pay", methods=['POST'])
def handlePay():
    connection = sqlite3.connect('database.db')
    cur = connection.cursor()
    amount = request.form.get("amount")
    if not amount:
        return "Missing amount", 400
    userid = request.form.get('userid')
    if not userid:
        return "Missing userid", 400
    hash_token = request.form.get('hash')
    if not hash_token:
        return "Missing hash",400
    trace_id = request.headers.get('X-Trace-Id')
    auth_token = request.headers.get('Authorization')
    if not trace_id:
        return "Missing trace id", 400
    if not auth_token:
        return "Missing Auth Token", 400
    cur.execute("INSERT INTO payments (userid, amount, traceid, paymentstatus) VALUES (?, ?, ?, ?)",(userid, amount, trace_id, "PENDING"))
    connection.commit()
    connection.close()
    calc_hash_token = hashlib.sha256(amount.encode()+b":"+userid.encode()+b":"+trace_id.encode()).hexdigest()
    trace_header = dict(request.headers)
    #Amount and hash gets passed to payment gateway
    handlePayment(amount, calc_hash_token, hash_token)
    trace_header["X-Trace-Id"] =  trace_id
    trace_header['X-Payment-For-'+userid] = amount
    return "Success", 200, trace_header

def handlePayment(amount, calc_hash_token, hash_token):
    pass

if __name__ == "__main__":
    connection = sqlite3.connect('database.db')
    with open('schema.sql') as f:
        connection.executescript(f.read())
    connection.commit()
    connection.close()
    app.run()
````

schema.sql
````
DROP TABLE IF EXISTS payments;

CREATE TABLE payments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    userid TEXT NOT NULL,
    amount INTEGER NOT NULL,
    traceid TEXT NOT NULL,
    paymentstatus TEXT NOT NULL
);
````
{{% /tab %}}
{{% tab tabName="Solution" %}}

````python {linenos=table,hl_lines=[3,"5-7"],anchorlinenos=true}
    Stay tuned for updates on the solution !!
````
{{% /tab %}}
{{< /tabs >}}

## References

- [https://cheatsheetseries.owasp.org/](https://cheatsheetseries.owasp.org/)
- [https://owasp.org/Top10/A03_2021-Injection/](https://owasp.org/Top10/A03_2021-Injection/)
- [https://docs.microsoft.com/en-us/dotnet/standard/security/](https://docs.microsoft.com/en-us/dotnet/standard/security/)
- [https://github.com/guardrailsio/awesome-dotnet-security](https://github.com/guardrailsio/awesome-dotnet-security)
- [https://owasp.org/www-project-top-ten/2017/Top_10.html](https://owasp.org/www-project-top-ten/2017/Top_10.html)
